name: CI - Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Detectar quais projetos foram modificados
  changes:
    name: Detectar Mudan√ßas
    runs-on: ubuntu-latest
    outputs:
      backend-spring: ${{ steps.filter.outputs.backend-spring }}
      backend-aspnet: ${{ steps.filter.outputs.backend-aspnet }}
      frontend: ${{ steps.filter.outputs.frontend }}
      mobile: ${{ steps.filter.outputs.mobile }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend-spring:
              - 'backend-springboot/**'
            backend-aspnet:
              - 'backend-aspnet/**'
            frontend:
              - 'frontend/**'
            mobile:
              - 'mobile/**'

  # Valida√ß√£o do Mobile (React Native / TypeScript)
  mobile-validate:
    name: Mobile - TypeScript Validation
    needs: changes
    if: needs.changes.outputs.mobile == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: mobile/package-lock.json

    - name: Instalar depend√™ncias
      working-directory: ./mobile
      run: npm ci

    - name: Verificar TypeScript
      working-directory: ./mobile
      run: npx tsc --noEmit

    - name: Lint (se configurado)
      working-directory: ./mobile
      run: npm run lint --if-present
      continue-on-error: true

    - name: Valida√ß√£o conclu√≠da
      run: |
        echo "‚úÖ Mobile: TypeScript v√°lido"
        echo "üì± Projeto React Native/Expo verificado"

  # Valida√ß√£o do Frontend Web
  frontend-validate:
    name: Frontend - HTML/CSS/JS Validation
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4

    - name: Validar estrutura do frontend
      run: |
        echo "üîç Verificando arquivos do frontend..."
        ls -la frontend/
        echo "‚úÖ Frontend: Estrutura v√°lida"

  # Valida√ß√£o do Backend Spring Boot
  backend-spring-validate:
    name: Backend Spring - Java Validation
    needs: changes
    if: needs.changes.outputs.backend-spring == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4

    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: 'maven'

    - name: Compilar projeto
      working-directory: ./backend-springboot
      run: mvn compile -DskipTests

    - name: Valida√ß√£o conclu√≠da
      run: |
        echo "‚úÖ Backend Spring Boot: Compila√ß√£o OK"

  # Valida√ß√£o do Backend ASP.NET Core
  backend-aspnet-validate:
    name: Backend ASP.NET - C# Validation
    needs: changes
    if: needs.changes.outputs.backend-aspnet == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4

    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restaurar e compilar
      working-directory: ./backend-aspnet/PetshopApi
      run: |
        dotnet restore
        dotnet build --no-restore

    - name: Valida√ß√£o conclu√≠da
      run: |
        echo "‚úÖ Backend ASP.NET Core: Compila√ß√£o OK"

  # Resumo final
  summary:
    name: Resumo CI
    needs: [changes, mobile-validate, frontend-validate, backend-spring-validate, backend-aspnet-validate]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Resumo das valida√ß√µes
      run: |
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "üìä RESUMO DO CI"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo ""
        echo "Projetos modificados:"
        echo "  ‚òï Backend Spring Boot: ${{ needs.changes.outputs.backend-spring }}"
        echo "  üü£ Backend ASP.NET:     ${{ needs.changes.outputs.backend-aspnet }}"
        echo "  üåê Frontend Web:        ${{ needs.changes.outputs.frontend }}"
        echo "  üì± Mobile:              ${{ needs.changes.outputs.mobile }}"
        echo ""
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

  # Job 1: Backend Tests (Spring Boot)
  backend-springboot-tests:
    name: Backend - Java 21 + Spring Boot Tests
    needs: changes
    if: needs.changes.outputs.backend-spring == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4

    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: 'maven'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Build e Test Backend
      working-directory: ./backend-springboot
      run: mvn clean verify

    - name: Gerar relat√≥rio de cobertura
      working-directory: ./backend-springboot
      run: mvn jacoco:report

    - name: Verificar threshold de cobertura (50%)
      working-directory: ./backend-springboot
      run: mvn jacoco:check

    - name: Upload cobertura para Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./backend-springboot/target/site/jacoco/jacoco.xml
        flags: springboot-backend
        name: springboot-coverage
        token: ${{ secrets.CODECOV_TOKEN }}
      continue-on-error: true

  # Job 2: Backend Tests (ASP.NET Core)
  backend-aspnet-tests:
    name: Backend - .NET 8 + ASP.NET Core Tests
    needs: changes
    if: needs.changes.outputs.backend-aspnet == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4

    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      working-directory: ./backend-aspnet/PetshopApi.Tests
      run: dotnet restore

    - name: Build projeto
      working-directory: ./backend-aspnet/PetshopApi.Tests
      run: dotnet build --no-restore

    - name: Run tests with coverage (threshold 50%)
      working-directory: ./backend-aspnet/PetshopApi.Tests
      run: dotnet test --no-build --verbosity normal

    - name: Upload cobertura para Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./backend-aspnet/PetshopApi.Tests/coverage.opencover.xml
        flags: aspnet-backend
        name: aspnet-coverage
        token: ${{ secrets.CODECOV_TOKEN }}
      continue-on-error: true

  # Job 3: Frontend Tests (Playwright) - DESABILITADO (requer backend rodando)
  # frontend-tests:
  #   name: Frontend - Playwright E2E
  #   runs-on: ubuntu-latest
  #   
  #   steps:
  #   - name: Checkout c√≥digo
  #     uses: actions/checkout@v4
  #
  #   - name: Setup Node.js
  #     uses: actions/setup-node@v4
  #     with:
  #       node-version: '18'
  #       cache: 'npm'
  #
  #   - name: Cache Playwright browsers
  #     uses: actions/cache@v4
  #     id: playwright-cache
  #     with:
  #       path: ~/.cache/ms-playwright
  #       key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}
  #
  #   - name: Instalar depend√™ncias
  #     run: npm ci
  #
  #   - name: Instalar browsers Playwright
  #     if: steps.playwright-cache.outputs.cache-hit != 'true'
  #     run: npx playwright install --with-deps
  #   
  #   - name: Instalar apenas depend√™ncias dos browsers
  #     if: steps.playwright-cache.outputs.cache-hit == 'true'
  #     run: npx playwright install-deps
  #
  #   - name: Setup Java 21 (para backend)
  #     uses: actions/setup-java@v4
  #     with:
  #       distribution: 'temurin'
  #       java-version: '21'
  #       cache: 'maven'
  #
  #   - name: Cache Maven dependencies
  #     uses: actions/cache@v4
  #     with:
  #       path: ~/.m2/repository
  #       key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
  #
  #   - name: Iniciar Backend (background)
  #     working-directory: ./backend-springboot
  #     run: |
  #       mvn spring-boot:run -DskipTests &
  #       echo $! > backend.pid
  #       # Aguardar backend estar pronto (reduzido para 60s)
  #       timeout 60 bash -c 'until curl -f http://localhost:8080/actuator/health 2>/dev/null; do sleep 2; done' || true
  #
  #   - name: Executar testes Playwright (apenas Chromium no CI)
  #     run: npx playwright test --project=chromium
  #     env:
  #       CI: true
  #
  #   - name: Parar Backend
  #     if: always()
  #     run: |
  #       if [ -f backend-springboot/backend.pid ]; then
  #         kill $(cat backend-springboot/backend.pid) || true
  #       fi
  #
  #   - name: Upload Playwright Report
  #     uses: actions/upload-artifact@v4
  #     if: always()
  #     with:
  #       name: playwright-report
  #       path: playwright-report/
  #       retention-days: 30
  #
  #   - name: Upload Screenshots de Falhas
  #     uses: actions/upload-artifact@v4
  #     if: failure()
  #     with:
  #       name: test-screenshots
  #       path: test-results/
  #       retention-days: 7

  # Job 4: Code Quality - DESABILITADO
  # code-quality:
  #   name: An√°lise de Qualidade
  #   runs-on: ubuntu-latest
  #   
  #   steps:
  #   - name: Checkout c√≥digo
  #     uses: actions/checkout@v4
  #     with:
  #       fetch-depth: 0  # Necess√°rio para SonarCloud
  #
  #   - name: Setup Java 21
  #     uses: actions/setup-java@v4
  #     with:
  #       distribution: 'temurin'
  #       java-version: '21'
  #       cache: 'maven'
  #
  #   - name: SonarCloud Scan (se configurado)
  #     working-directory: ./backend-springboot
  #     env:
  #       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  #     run: |
  #       if [ -n "$SONAR_TOKEN" ]; then
  #         mvn verify sonar:sonar \
  #           -Dsonar.projectKey=andreaspsb_Fundamentos-de-Sistemas-Web-Com-BackEnd \
  #           -Dsonar.organization=andreaspsb \
  #           -Dsonar.host.url=https://sonarcloud.io
  #       else
  #         echo "SonarCloud n√£o configurado - pulando"
  #       fi
  #     continue-on-error: true

  # Job 5: Build Success Notification - DESABILITADO
  # notify-success:
  #   name: Notifica√ß√£o de Sucesso
  #   needs: [frontend-tests]
  #   runs-on: ubuntu-latest
  #   if: success()
  #   
  #   steps:
  #   - name: Build passou ‚úÖ
  #     run: |
  #       echo "‚úÖ Todos os testes passaram!"
  #       echo "‚úÖ Testes Playwright: OK"
